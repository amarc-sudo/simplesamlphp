#!/usr/bin/php -q
<?php
/**
 * Generate .mo files based on the template .po files.
 */
declare(strict_types=1);

use Gettext\Generator\MoGenerator;
use Gettext\Loader\PoLoader;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Finder\Finder;

// This is the base directory of the SimpleSAMLphp installation
$baseDir = dirname(__FILE__, 2);

// Add library autoloader
require_once($baseDir . '/src/_autoload.php');

$modules = ['', 'core', 'admin', 'cron', 'exampleauth', 'multiauth', 'saml'];

$loader = new PoLoader();
$generator = new MoGenerator();
$fileSystem = new Filesystem();

foreach ($modules as $module) {
    $moduleDir = $baseDir . ($module === '' ? '' : '/modules/' . $module);
    $moduleLocalesDir = $moduleDir . '/locales/';

    if ($fileSystem->exists($moduleLocalesDir)) {
        $finder = new Finder();
        foreach ($finder->files()->in($moduleLocalesDir . '**/LC_MESSAGES/')->name('*.po') as $poFile) {
            $translations = $loader->loadFile($poFile->getPathName());
            $moFileName = substr($poFile->getPathName(), 0, -3) . '.mo';

            // Overwrite the current .mo file with a fresh one
            $generator->generateFile($translations, $moFileName);
        }
    }
}
