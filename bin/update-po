#!/usr/bin/php -q
<?php
/**
 * Update .po files based on the template .pot files.
 */
declare(strict_types=1);

use Gettext\Generator\PoGenerator;
use Gettext\Loader\PoLoader;
use Gettext\Merge;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Finder\Finder;

// This is the base directory of the SimpleSAMLphp installation
$baseDir = dirname(__FILE__, 2);

// Add library autoloader
require_once($baseDir . '/src/_autoload.php');

$modules = ['', 'core', 'admin', 'cron', 'exampleauth', 'multiauth', 'saml'];

$loader = new PoLoader();
$generator = new PoGenerator();
$fileSystem = new Filesystem();

foreach ($modules as $module) {
    $moduleDir = $baseDir . ($module === '' ? '' : '/modules/' . $module);
    $moduleLocalesDir = $moduleDir . '/locales/';

    if ($fileSystem->exists($moduleLocalesDir)) {
        $finder = new Finder();
        foreach ($finder->files()->in($moduleLocalesDir)->name('*.pot') as $potFile) {
            $template = $loader->loadFile($potFile->getPathName());

            $poFileName = substr($potFile->getFileName(), 0, -1);
            $finder = new Finder();
            foreach ($finder->files()->in($moduleLocalesDir . '/**/LC_MESSAGES/')->name($poFileName) as $poFile) {
                $translations = $loader->loadFile($poFile->getPathName());

                // Merge the translations with the template
                $merged = $template->mergeWith(
                    $translations,
                    Merge::TRANSLATIONS_THEIRS | Merge::COMMENTS_OURS | Merge::HEADERS_OURS,
                );

                // Overwrite the current .po file with a fresh one
                $generator->generateFile($merged, $poFile->getPathName());
            }
        }
    }
}
