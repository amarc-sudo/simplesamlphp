#!/usr/bin/php -q
<?php
/**
 * Find translatable strings in Twig templates and the PHP library
 * and merge them into the English PO file.
 *
 * It should be invoked from the root of a SimpleSAMLphp installation
 * and can work on:
 * - A specific module name given on the command line
 * - The main product and the standard modules, when invoked with '--main'.
 *
 * It will search all Twig templates for occurrences of the trans()
 * function, and all PHP code under src/ for the noop() function.
 */
declare(strict_types=1);

use Gettext\Scanner\PhpScanner;
use Gettext\Generator\PoGenerator;
use Gettext\Translations;
use SimpleSAML\Utils;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Finder\Finder;

// This is the base directory of the SimpleSAMLphp installation
$baseDir = dirname(__FILE__, 2);

// Add library autoloader
require_once($baseDir . '/src/_autoload.php');

if ($argc !== 2) {
    echo "Usage: $argv[0] (<module>|--main)\n";
    exit(1);
}

if ($argv[1] === '--main') {
    $modules = ['', 'core', 'admin', 'cron', 'exampleauth', 'multiauth', 'saml'];
} else {
    $modules = [$argv[1]];
}

$transUtils = new Utils\Translate();
$sysUtils = new Utils\System();
$filesystem = new Filesystem();

$tempDirBase = $sysUtils->getTempDir() . "/temptemplatestemp";
// Ensure no leftover from any previous invocation
$filesystem->remove($tempDirBase);

$translationDomains = [];
foreach ($modules as $module) {
    $domain = $module ?: 'messages';
    $translationDomains[] = Translations::create($domain);
}

$phpScanner = new PhpScanner(...$translationDomains);
$phpScanner->setFunctions(['trans' => 'gettext', 'noop' => 'gettext']);
$finder = new Finder();

// Scan files in base
foreach ($modules as $module) {
    $tempDir = $tempDirBase . $module;
    $transUtils->compileAllTemplates($module, $tempDir);

    // Set the proper domain
    $phpScanner->setDefaultDomain($module ?: 'messages');

    $moduleDir = $baseDir . ($module === '' ? '' : '/modules/' . $module);
    $moduleSrcDir = $moduleDir . '/src/';

    // Scan PHP files
    foreach ($finder->files()->in($moduleSrcDir)->name('*.php') as $file) {
        $phpScanner->scanFile($file->getPathName());
    }

    // Scan compiled Twig-templates
    foreach ($finder->files()->in($tempDir)->name('*.php') as $file) {
        $phpScanner->scanFile($file->getPathName());
    }
}

// Save the translations in .po files
$generator = new PoGenerator();

foreach ($phpScanner->getTranslations() as $domain => $translations) {
    $moduleDir = $baseDir . ($domain === 'messages' ? '' : '/modules/' . $domain);
    $outputDir = $moduleDir . '/locales/en/LC_MESSAGES';
    $domain = $domain ?: 'messages';
    $generator->generateFile($translations, "{$outputDir}/{$domain}.pot");
}

$filesystem->remove($tempDirBase);
// TODO: merge new strings into translated languages catalogs
