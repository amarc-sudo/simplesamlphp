#!/usr/bin/php -q
<?php
/**
 * Find translatable strings in Twig templates and the PHP library
 * and merge them into the English PO file.
 *
 * It should be invoked from the root of a SimpleSAMLphp installation
 * and can work on:
 * - A specific module name given on the command line
 * - The main product and the standard modules, when invoked with '--main'.
 *
 * It will search all Twig templates for occurrences of the trans()
 * function, and all PHP code under src/ for the noop() function.
 */
declare(strict_types=1);

use Gettext\Scanner\PhpScanner;
use Gettext\Generator\MoGenerator;
use Gettext\Generator\PoGenerator;
use Gettext\Loader\PoLoader;
use Gettext\Merge;
use Gettext\Translation;
use Gettext\Translations;
use SimpleSAML\Configuration;
use SimpleSAML\Logger;
use SimpleSAML\Utils;
use SimpleSAML\TestUtils\ArrayLogger;
use SimpleSAML\XHTML\TemplateLoader;
use Symfony\Bridge\Twig\Translation\TwigExtractor;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Finder\Finder;
use Symfony\Component\Translation\MessageCatalogue;
use Twig\Environment;

// This is the base directory of the SimpleSAMLphp installation
$baseDir = dirname(__FILE__, 2);

// Add library autoloader
require_once($baseDir . '/src/_autoload.php');

if ($argc !== 2) {
    echo "Usage: $argv[0] (<module>|--main)\n";
    exit(1);
}

$core_modules = ['core', 'admin', 'cron', 'exampleauth', 'multiauth', 'saml'];

if ($argv[1] === '--main') {
    $modules = array_merge([''], $core_modules);
} else {
    $modules = [$argv[1]];
}

$fileSystem = new Filesystem();

$translationDomains = [];
foreach ($modules as $module) {
    $domain = $module ?: 'messages';
    $translationDomains[] = Translations::create($domain);
}

$phpScanner = new PhpScanner(...$translationDomains);
$phpScanner->setFunctions(['trans' => 'gettext', 'noop' => 'gettext']);

$twigTranslations = [];
// Scan files in base
foreach ($modules as $module) {
    // Set the proper domain
    $phpScanner->setDefaultDomain($module ?: 'messages');

    $moduleDir = $baseDir . ($module === '' ? '' : '/modules/' . $module);
    $moduleSrcDir = $moduleDir . '/src/';
    $moduleTemplateDir = $moduleDir . '/templates/';

    // Scan PHP files
    $finder = new Finder();
    foreach ($finder->files()->in($moduleSrcDir)->name('*.php') as $file) {
        $phpScanner->scanFile($file->getPathName());
    }

    // Scan Twig-templates
    $finder = new Finder();
    foreach ($finder->files()->in($moduleTemplateDir)->name('*.twig') as $file) {
        $loader = new \SimpleSAML\XHTML\TemplateLoader([$moduleTemplateDir]);
        $env = new \Twig\Environment($loader);

        $catalogue = new MessageCatalogue('en', []);
        $extractor = new TwigExtractor($env);
        $extractor->extract($file, $catalogue);

        $tmp = $catalogue->all();
        if ($tmp === []) {
            // This template has no translation strings
            continue;
        }

        // The catalogue always uses 'messages' for the domain and it's not configurable.
        // Manually replace it with the module-name
        if ($module !== '') {
            $tmp[$module] = $tmp['messages'];
            unset($tmp['messages']);
        }
        $twigTranslations[] = $tmp;
    }
}

// The catalogue returns an array with strings, while the php-scanner returns Translations-objects.
// Migrate the catalogue results to match the php-scanner results.
$migrated = [];
foreach ($twigTranslations as $t) {
    foreach ($t as $domain => $translation) {
        $trans = Translations::create($domain);
        foreach ($translation as $s => $t) {
            $trans->add(Translation::create(null, $s, $t));
        }
        $migrated[$domain][] = $trans;
    }
}

$loader = new PoLoader();
$poGenerator = new PoGenerator();
$moGenerator = new MoGenerator();

foreach ($phpScanner->getTranslations() as $domain => $template) {
    // If we also have results from the Twig-templates, merge them
    if (array_key_exists($domain, $migrated)) {
        foreach ($migrated[$domain] as $migratedTranslations) {
            $template = $template->mergeWith($migratedTranslations);
        }
    }

    // If we have at least one translation, write it into a template file
    if ($template->count() > 0) {
        $moduleDir = $baseDir . ($domain === 'messages' ? '' : '/modules/' . $domain);
        $moduleLocalesDir = $moduleDir . '/locales/';
        $domain = $domain ?: 'messages';

        $finder = new Finder();
        foreach ($finder->files()->in($moduleLocalesDir . '**/LC_MESSAGES/')->name("{$domain}.po") as $poFile) {
            $current = $loader->loadFile($poFile->getPathName());
            $merged = $template->mergeWith(
                $current,
                Merge::TRANSLATIONS_THEIRS | Merge::COMMENTS_OURS | Merge::HEADERS_OURS,
            );

            $poGenerator->generateFile($merged, $poFile->getPathName());
            $moGenerator->generateFile($merged, substr($poFile->getPathName(), 0, -3) . '.mo');
        }
    }
}
